<!DOCTYPE html>
<html>
<head>
  <title>管理页 用户列表</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.1.3/css/bootstrap.min.css">
  <script src="https://cdn.staticfile.org/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://cdn.staticfile.org/twitter-bootstrap/4.1.3/js/bootstrap.min.js"></script>

  <script>
		import * as utils from "/mealordering/assets/js/utils";
		import * as global from "/mealordering/assets/js/global";

		let curPageIndex = 1;
		//尝试得到get参数
		let data = utils.getParamMap();
		let url = "/mealordering/admin/findAllUsers";
		//如果是按名字搜索的情况
		if(data["name"] != null) {
			url = "/mealordering/admin/searchUserByUserName";
		}

		$(function() {
			$("#mo-head").load("/mealordering/admin/mo-head.html");
			$("#mo-background-bar").load("/mealordering/admin/mo-background-bar.html");
			$("#mo-foot").load("/mealordering/admin/mo-foot.html");
			$("#mo-side-menu").load("/mealordering/admin/mo-side-menu.html", function() {
				//切换侧边栏激活
				$("#mo-side-menu .nav-link").removeClass("active").eq("4").addClass("active");
			});

			//通过Ajax得到数据，接着插入相应的位置
			$.post(url, data, function(data) {
				generate(data);
			});

			/**
			 * 生成页面
			 * @property {string} data.status
			 * @property {object[]} data.page
			 * @property {string[]} data.pageBtnText
			 * @property {int} data.pageIndex
			 * @property {int} data.pageCount
			 */
			function generate(data) {
				//NOTE 如果没有数据，则显示提示
				if(data.status === "empty") {
					let $content = $("#mo-body-content-admin");
					$content.empty();
					$content.append(`
				<div class="row m-3 text-center text-success">
					<h4>餐品数据为空</h4>
				</div>
				<hr>
				<div class="row m-3 text-center text-success">
					<p>看看其他内容吧......</p>
				</div>
            `);
				}
				//NOTE 如果发生错误，则跳转到错误页
				else if(data.status === "error") {
					location.href = "/mealordering/error/unexpected-error.html";
				}
				//NOTE 如果一切正常，则插入数据
				else {
					//更改当前索引
					curPageIndex = data.pageIndex;

					//插入数据
					let $tbody = $("#mo-body-table-admin tbody");
					$tbody.empty();
					for(const user of data.page) {
						let state = user.activeState === 0 ? "未激活" : "已激活";
						let date = utils.formatDate(user.registerTime);
						$tbody.append(`
								<tr class="mo-col-meal">
									<td>${user.id}</td>
									<td>${user.userName}</td>
									<td>${user.gender}</td>
									<td>${user.email}</td>
									<td>${user.phoneNum}</td>
									<td>${user.type}</td>
									<td>${state}</td>
									<td>${date}</td>
									<td>
										<button class="btn btn-info mo-btn-detail">详情</button>
									</td>
								</tr>
							`);
					}

					//为详情按钮配置链接
					let $btnDetail = $(".mo-btn-detail");
					$btnDetail.off("click");
					$btnDetail.on("click", function() {
						//得到参数（餐品id）
						let id = $(this).parent().parent().find(":first-child").text();
						//跳转到餐品详情页
						location.href = `/mealordering/admin/user-info.html?id=${id}`;
					});


					//插完数据后就生成分页栏
					let $pagination = $("#mo-page-bar-admin .pagination");
					$pagination.empty();
					global.generatePageBar($pagination, data.pageBtnText, data.pageIndex, data.pageCount);

					//为分页栏“上一页”按钮配置链接
					let $prePage = $("#mo-pre-page");
					$prePage.off("click");
					$prePage.on("click", function() {
						$.post("/mealordering/getPage", {pageIndex: curPageIndex - 1}, function(data) {
								generate(data);
							}
						);
					});
					//为分页栏“页数”按钮配置链接
					let $changePage = $(".mo-change-page");
					$changePage.off("click");
					$changePage.on("click", function() {
						$.post("/mealordering/getPage", {pageIndex: $(this).text()}, function(data) {
								generate(data);
							}
						);
					});
					//为分页栏“下一页”按钮配置链接
					let $nextPage = $("#mo-next-page");
					$nextPage.off("click");
					$nextPage.on("click", function() {
						$.post("/mealordering/getPage", {pageIndex: curPageIndex + 1}, function(data) {
								generate(data);
							}
						);
					});

				}
			}
		});
  </script>
</head>

<body>
  <!--INFO 页面顶部-->
  <div id="mo-head"></div>

  <!--INFO 背景图-->
  <div class="container-fluid" id="mo-background-bar"></div>

  <!--INFO 页面主体-->
  <div class="container" id="mo-body-admin">
    <div class="row">
      <!--INFO 侧边菜单栏-->
      <div class="col-sm-3">
        <div class="container" id="mo-side-menu"></div>
      </div>

      <!--INFO 内容页面-->
      <div class="col-sm-9">
        <div class="container" id="mo-body-content-admin">
          <!--INFO 标题-->
          <div class="row m-3 ">
            <div class="col-sm-6">
              <h2>用户列表</h2>
            </div>
            <div class="col-sm-5" id="mo-search-by-name">
              <form class="form-inline" action="user-list.html" method="get">
                <div class="form-group">
                  <label class="sr-only" for="mo-by-name">名称</label>
                  <input type="text" class="form-control" id="mo-by-name" name="name"
                         placeholder="按名字搜索" required>
                </div>
                <button type="submit" class="btn btn-default">
                  <span class="fa fa-search"></span>
                </button>
              </form>
            </div>
          </div>
          <hr>
          <!--INFO 表格-->
          <div class="row" id="mo-body-table-admin">
            <table class="table table-bordered table-striped table-hover table-responsive m-auto">
              <thead class="thead-dark text-center">
              <tr>
                <th>id</th>
                <th>用户名</th>
                <th>性别</th>
                <th>邮箱</th>
                <th>手机号码</th>
                <th>类型</th>
                <th>激活状态</th>
                <th>注册时间</th>
              </tr>
              </thead>
              <!--NOTE 动态生成-->
              <tbody class="text-center"></tbody>
            </table>
          </div>

          <!--INFO 分页栏-->
          <div class="row" id="mo-page-bar-admin">
            <!--NOTE 动态生成-->
            <ul class="pagination"></ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!--INFO 页面尾部-->
  <div class="container" id="mo-foot"></div>
</body>
</html>
